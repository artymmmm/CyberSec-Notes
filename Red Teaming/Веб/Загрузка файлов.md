Уязвимости загрузки файлов возникают, когда атакующий может загрузить файл на сервер без достаточной валидации названия, типа, контента и размера файла
## Источники информации
- [File Upload Learning Path PortSwigger Academy](https://portswigger.net/web-security/learning-paths/file-upload-vulnerabilities/)
## Полезные нагрузки
### PHP
- Чтение файла: `<?php echo file_get_contents('/path/to/target/file'); ?>`
- Веб шелл: `<?php echo system($_GET['command']); ?>`
## Загрузка веб шелла
- Если сервер позволяет загружать скрипты (PHP, Java, Python) и выполняет их, атакующий может загрузить на сервер веб шелл: `<?php echo system($_GET['command']); ?>` (запрос для выполнения команд на сервере: `GET /exploit.php?command=id HTTP/1.1)
## Обход ограничений
### Content-Type
- Сервер может сравнивать заголовок Content-Type из HTTP-запроса с ожидаемым MIME-типом (при загрузке изображений обычно это `image/jpeg` и `image/png`). Атакующий может изменить Content-Type в запросе, чтобы обойти ограничение на сервере (например, скрипт PHP с MIME-типом `application/x-httpd-php` изменить на `image/jpeg`)
- Сервер может проверять Magic bytes в начале файла, после них можно вставить полезную нагрузку: `PNG<?php echo system($_GET['command']); ?>`
### Запрет на выполнение файлов
Сервер может не иметь прав исполнять файлы в каталогах, куда пользователи могут загружать файлы, чтобы предотвратить выполнение вредоносных файлов. Атакующий может попытаться загрузить файл в другой каталог, куда загрузка не предполагается (например, использовать [[Path Traversal]])
### Запрет на опасные файлы
Если используется черный список расширений, можно попробовать его обойти редко встречающимися форматами: `.php5`, `.shtml`
### Изменение конфигурации сервера
Атакующий может загрузить на сервер свой конфигурационный файл (`.htaccess` для Apache, `web.config` для IIS) с целью изменить ограничения сервера, например, позволить серверу выполнять PHP-файлы. 
Примеры:
- Атакующий не может загружать PHP-файлы, но может загружать HTML-файлы, которые не выполняются как PHP. В таком случае атакующий загружает файл `.htaccess`: `AddType application/x-httpd-php .html .htm` (выполнять HTML-, HTM-файлы как PHP), тогда загруженные HTML-файлы с кодом PHP будут выполняться на сервере
- Атакующий может загружать любые файлы кроме PHP, тогда он может загрузить файл `.htaccess`: `AddType application/x-httpd-php .abcd`. Сервер будет выполнять файлы с расширением `.abcd` как PHP-файлы
### Обфускация расширений
- Изменение регистра: `exploit.pHp`
- Несколько расширений: `exploit.php.jpg`
- Завершающие символы/Trailing characters (пробелы, точки): `exploit.php.`
- URL-кодировка или двойная URL-кодировка (точки, слэши, обратные слэши): `exploit%2Ephp`
- Точка с запятой, нулевые байты: `exploit.asp;.jpg`, `exploit.asp%00.jpg`
- Многобайтовые символы Unicode: `xC0 x2E`, `xC4 xAE`, `xC0 xAE` -> `x2E` -> `.`
- Удвоение расширения (в случае удаления серверов запрещенного расширения): `exploit.p.phphp` -> `exploit.php`
### Магические байты/символы/сигнатуры
Для определения формата файла помимо Content-Type сервер может проверять [магические байты](https://filesig.search.org/) в файле. Атакующий может к магическим байтам вставить свою полезную нагрузку, например, к байтам `FF D8 FF` (JPEG) добавить веб-шелл `<?php echo system($_GET['command']); ?>`. Это можно сделать через Burp Suite Repeater или ExifTool.
## Состояние гонки (Race condition)
- Обычно веб-приложение при загрузке файла сначала загружает его в песочницу для проверки, после чего помещает в файловую систему. Если сервер сразу его помещает в файловую систему, а потом проводит проверку (например, на вирусы), то  атакующий до удаления файла может успеть его выполнить.
- Если сервер загружает файл из URL-пути, который отправляет пользователь, сервер сразу отправит файл в файловую систему. Однако, обычно для проверки используют каталоги со случайным именем, чтобы их невозможно было найти, например, с помощью псевдослучайной PHP-функции `uniqid()`. Такую функцию атакующий может сбрутить. Для увеличения времени проверки файла атакующий может сделать его очень большим.
## Эксплуатация загрузки файлов без удаленного выполнения кода
- Атакующий может загрузить HTML-файлы или SVG-изображения, содержащие JS-код, с целью реализовать атаку хранимого XSS. JS-код будет выполнен в браузере жертвы.
- Атакующий может загрузить файлы, содержащие XML (например, `.doc`, `.xls`), с целью реализации инъекции XXE.
## Загрузка файлов с помощью метода PUT
Сервер может поддерживать PUT-запросы, с помощью которых возможно загрузить файл (проверить поддержку PUT-запросов можно через OPTIONS-запросы):
```HTTP
PUT /images/exploit.php HTTP/1.1 
Host: vulnerable-website.com 
Content-Type: application/x-httpd-php 
Content-Length: 49 

<?php echo file_get_contents('/path/to/file'); ?>
```